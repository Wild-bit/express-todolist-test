# 快速参考 - Node.js & Express 核心概念

## 🚀 Node.js 模块加载

### 执行顺序
```bash
node main.js
├── require("express")           # 第三方模块
├── require("./middleware")      # 本地模块  
├── require("./routes")          # 路由模块
│   └── require("./controller")  # 控制器
│       └── require("./storage") # 存储模块 ← 初始化在这里
└── app.listen(3000)            # 启动服务器
```

### 关键特性
- ✅ **同步加载**：遇到 `require()` 立即加载
- ✅ **模块缓存**：同一模块只加载一次
- ✅ **依赖递归**：深度优先加载依赖

---

## ⚡ Express 中间件执行

### 注册顺序（重要！）
```javascript
// 1. 日志中间件（最外层）
app.use(loggerMiddleware);

// 2. 解析中间件
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// 3. 静态文件中间件
app.use(express.static("public"));

// 4. 路由（最内层）
app.use("/api", apiRoutes);
```

### 洋葱模型执行流程
```
请求 → 中间件1进入 → 中间件2进入 → 路由处理 → 中间件2返回 → 中间件1返回 → 响应
```

---

## 🧅 洋葱模型示例

```javascript
app.use((req, res, next) => {
  console.log('🔵 进入');  // 请求阶段
  next();
  console.log('🟢 返回');  // 响应阶段
});

// 输出：
// 🔵 进入
// 🟢 返回
```

---

## 💡 最佳实践

### ✅ 推荐的控制器写法
```javascript
class TodoController {
  static getAllTodos(req, res) {
    try {
      const todos = storage.getAllTodos();
      res.json({ success: true, data: todos });
    } catch (error) {
      res.status(500).json({ success: false, message: error.message });
    }
  }
}
```

### ✅ 推荐的路由写法
```javascript
const router = express.Router();
router.get('/todos', TodoController.getAllTodos);
router.post('/todos', TodoController.createTodo);
app.use('/api', router);
```

### ✅ 推荐的错误处理
```javascript
// 全局错误处理（放在最后）
app.use((err, req, res, next) => {
  console.error('错误:', err);
  res.status(500).json({ success: false, message: '服务器错误' });
});
```

---

## 🔍 常见问题

### Q: 为什么示例数据先初始化？
**A:** 因为初始化代码在 `storage.js` 模块加载时执行，不是在处理请求时执行。

### Q: Express 有洋葱模型吗？
**A:** 有！`next()` 之后的代码在响应完成后执行，形成洋葱模型。

### Q: 中间件顺序重要吗？
**A:** 非常重要！错误的顺序会导致功能异常。

### Q: 如何避免模块加载时的副作用？
**A:** 提供初始化方法，而不是在模块加载时自动执行。

---

## 📋 检查清单

### 模块设计
- [ ] 避免模块加载时的副作用
- [ ] 提供明确的初始化方法
- [ ] 正确处理模块依赖

### 中间件配置
- [ ] 日志中间件在最前面
- [ ] 解析中间件在业务逻辑之前
- [ ] 错误处理中间件在最后面

### 控制器设计
- [ ] 使用静态方法或对象导出
- [ ] 完善的错误处理
- [ ] 清晰的函数注释

### 路由配置
- [ ] 使用 Router 进行模块化
- [ ] 合理的路径前缀
- [ ] RESTful API 设计

---

*快速参考 - 随时查阅核心概念*